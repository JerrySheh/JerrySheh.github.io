import{_ as i,c as a,f as e,o as t}from"./app-D22ydJtp.js";const n={};function l(h,s){return t(),a("div",null,s[0]||(s[0]=[e(`<p>最近因为项目使用的 MySQL 数据库升级，Java 应用所使用的 MySQL Connector/J 驱动程序也需要同步升级，然而升级后却遇到了一些问题...</p><h2 id="升级版本号" tabindex="-1"><a class="header-anchor" href="#升级版本号"><span>升级版本号</span></a></h2><blockquote><p>5.1.44 --&gt; 8.0.32</p></blockquote><p><a href="https://dev.mysql.com/blog-archive/mysql-connectorj-5-1-44/" target="_blank" rel="noopener noreferrer">5.1.44</a> 是2017年8月30日发布的，而 <a href="https://dev.mysql.com/doc/relnotes/connector-j/8.0/en/news-8-0-32.html" target="_blank" rel="noopener noreferrer">8.0.32</a> 发布于2023年1月17日，前后横跨了6年，可能会出现不兼容，所以生产环境升级需要非常谨慎。</p><blockquote><p>注意，本文讨论的是 Java 程序使用的，用于连接 MySQL 服务器的驱动程序（客户端），即 MySQL Connector/J 的版本号，并非 MySQL 数据库的版本号。</p></blockquote><hr><h2 id="问题1-建立连接警告日志" tabindex="-1"><a class="header-anchor" href="#问题1-建立连接警告日志"><span>问题1. 建立连接警告日志</span></a></h2><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>Loading class \`com.mysql.jdbc.Driver&#39;. </span></span>
<span class="line"><span>This is deprecated. The new driver class is \`com.mysql.cj.jdbc.Driver&#39;.</span></span>
<span class="line"><span>The driver is automatically registered via the SPI and manual loading </span></span>
<span class="line"><span>of the driver class is generally unnecessary.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>意思就是新版本的驱动改了名字，只需要修改加载驱动的配置即可，如</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="问题2-默认时间类型由-timestamp-变更为-localdatetime" tabindex="-1"><a class="header-anchor" href="#问题2-默认时间类型由-timestamp-变更为-localdatetime"><span>问题2. 默认时间类型由 Timestamp 变更为 LocalDatetime</span></a></h2><p>通常我们使用 Mybatis ，如数据库的字段是 datetime，应用程序使用 Map 接收</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Map</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">String</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> Object</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> resultMap</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> dao</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">getSomething</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">param</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Date</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Date</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> resultMap</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">time</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>此时会抛出一个异常</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>java.time.LocalDateTime cannot be cast to java.util.Date</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>原因是旧版本驱动使用 java.sql.TimeStamp（extends Date）进行构造，最后转化为Date类型，而新版本驱动直接使用了 java8 的 LocalDateTime。</p><p>解决办法是应用程序使用 LocalDateTime 来接收：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">LocalDateTime</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> d</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">LocalDateTime</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> resultMap</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">time</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>或者在 Mybatis 的 xml 中配置 resultMap ，将指定字段映射为 Date 类型</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">resultMap</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> id</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">getByIdResultMap</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> type</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">User</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">	&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">result</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> property</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">time</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> column</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">time</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> javaType</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">java.util.Date</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">result</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">resultMap</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">select</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> id</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">getById</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> resultMap</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">getByIdResultMap</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        SELECT</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            t.time,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        FROM t</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        WHERE ..</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">select</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，多提一句，如果使用的是 oracle 数据库，并使用 ojdbc6 的驱动，那么无法将 LocalDateTime 落地到数据库的 date 类型，请升级 ojdbc 驱动或者把 LocalDateTime 在应用中转成 java.util.Date 。</p><hr><h2 id="问题3-时间相差13小时" tabindex="-1"><a class="header-anchor" href="#问题3-时间相差13小时"><span>问题3. 时间相差13小时</span></a></h2><p>驱动从 5.1.x 升级到 8.0.x 后，如果不指定时区，可能会出现落库的时间比实际时间相差 13 个小时的情况。</p><p>这是因为不指定时区，数据库默认时区是 CST ，驱动会从数据库服务端取到该时区， 而 JDK 却误以为 CST 是美国芝加哥的时区 UTC-5，但国内的时间是 UTC+8，换算成US的时间就是，当前时间 - 8 - 5，即时间少 13 小时。</p><blockquote><p>CST 可以表示好多种时间，例如中国标准时间、美国中部时间、古巴标准时间、澳大利亚中部时间</p></blockquote><p>MySQL Connector/J 在 <a href="https://dev.mysql.com/doc/relnotes/connector-j/8.0/en/news-8-0-23.html" target="_blank" rel="noopener noreferrer">8.0.23</a> 版本中修复了这个问题，所以我们直接用高于 8.0.22 版本的驱动即可避免。</p><hr><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>可能还有一些问题我没遇到或未记录，例如 <code>useSSL</code> 的差异等。<strong>但总而言之，在做比较大的升级前，多查阅官方更新日志，多提前搜索相关问题，生产环境上线前多多测试，甚至问问 chatgpt 还有什么需要注意的，可能都能帮助我们避免踩到坑</strong>。问题总是会存在的，但态度和策略，以及思考如何将可能的影响降低到最小，能尽可能帮助我们把潜在的风险最小化。</p>`,31)]))}const k=i(n,[["render",l],["__file","index.html.vue"]]),r=JSON.parse('{"path":"/java/ddvekb93/","title":"升级JDBC驱动可能会遇到的问题","lang":"zh-CN","frontmatter":{"title":"升级JDBC驱动可能会遇到的问题","categories":["Java","JDBC"],"abbrlink":"6b53f88a","createTime":"2023/08/09 20:41:42","permalink":"/java/ddvekb93/","description":"最近因为项目使用的 MySQL 数据库升级，Java 应用所使用的 MySQL Connector/J 驱动程序也需要同步升级，然而升级后却遇到了一些问题... 升级版本号 5.1.44 --> 8.0.32 5.1.44 是2017年8月30日发布的，而 8.0.32 发布于2023年1月17日，前后横跨了6年，可能会出现不兼容，所以生产环境升级需要...","head":[["meta",{"property":"og:url","content":"https://jerrysheh.com/java/ddvekb93/"}],["meta",{"property":"og:site_name","content":"Jerry"}],["meta",{"property":"og:title","content":"升级JDBC驱动可能会遇到的问题"}],["meta",{"property":"og:description","content":"最近因为项目使用的 MySQL 数据库升级，Java 应用所使用的 MySQL Connector/J 驱动程序也需要同步升级，然而升级后却遇到了一些问题... 升级版本号 5.1.44 --> 8.0.32 5.1.44 是2017年8月30日发布的，而 8.0.32 发布于2023年1月17日，前后横跨了6年，可能会出现不兼容，所以生产环境升级需要..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-10-20T05:02:32.000Z"}],["meta",{"property":"article:modified_time","content":"2024-10-20T05:02:32.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"升级JDBC驱动可能会遇到的问题\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-10-20T05:02:32.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"升级版本号","slug":"升级版本号","link":"#升级版本号","children":[]},{"level":2,"title":"问题1. 建立连接警告日志","slug":"问题1-建立连接警告日志","link":"#问题1-建立连接警告日志","children":[]},{"level":2,"title":"问题2. 默认时间类型由 Timestamp 变更为 LocalDatetime","slug":"问题2-默认时间类型由-timestamp-变更为-localdatetime","link":"#问题2-默认时间类型由-timestamp-变更为-localdatetime","children":[]},{"level":2,"title":"问题3. 时间相差13小时","slug":"问题3-时间相差13小时","link":"#问题3-时间相差13小时","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"readingTime":{"minutes":2.84,"words":853},"git":{"createdTime":1729400552000,"updatedTime":1729400552000,"contributors":[{"name":"jerrysheh","email":"jerrysheh@gmail.com","commits":1}]},"autoDesc":true,"filePathRelative":"notes/java/JDBC/升级JDBC驱动可能会遇到的问题.md"}');export{k as comp,r as data};
