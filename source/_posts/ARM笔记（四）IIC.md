---
title: ARM笔记（四）IIC
categories: ARM基础
tags: ARM
abbrlink: f86c33d
date: 2017-10-16 16:52:01
---

什么是 IIC ?

I²C（Inter-Integrated Circuit）字面上的意思是集成电路之间，它其实是I²C Bus简称，所以中文应该叫集成电路总线，它是一种串行通信总线，使用多主从架构，由飞利浦公司在1980年代为了让主板、嵌入式系统或手机用以连接低速周边设备而发展。I²C的正确读法为“I平方C”（"I-squared-C"）.  ————摘自维基百科

IIC 即Inter-Integrated Circuit(集成电路总线），这种总线类型是由飞利浦半导体公司在八十年代初设计出来的一种简单、双向、二线制、同步串行总线，主要是用来连接整体电路(ICS) ，IIC是一种多向控制总线，也就是说多个芯片可以连接到同一总线结构下，同时每个芯片都可以作为实时数据传输的控制源。这种方式简化了信号传输总线接口。 ————摘自百度百科

我的简单理解是，IIC用于器件之间的通信。通过SDA（串行数据线）和SCL（串行时钟线）两根线在连到总线上的器件之间传送信息。

笔记（四）涉及到的知识：
1. IIC引脚
2. IIC相关寄存器
3. 例子

<!-- more -->

---

# 一. 引脚

引脚|引脚名称|描述
---|---
p0.2|SCL（串行时钟线）|串行时钟输入/输出，开漏输出
p0.3|SDA（串行数据线）|串行数据输入/输出，开漏输出


设置方法：PINSEL0第  7:4 位 设为 0101

```c
PINSEL0 = (PINSEL0 & 0xFFFFFF0F) | 0x50;
```

---

# 二. IIC相关寄存器

![IICI](../../../../images/ARM/IIC2I.png)

---

## 1. I2C控制置位寄存器I2CONSET

功能：I2CONSET用于置位I2C通信的相关标志位，该寄存器只能对某位置位，而不能清零，清零通过I2CONCLR寄存器完成。

位|7|6|5|4|3|2|[1:0]
---|---
功能|保留|I2EN|STA|STO|SI|AA|保留

AA为声明应答标志：当该位置位时，在SCL线的应答时钟脉冲内，出现下面的任意条件之一将产生一个应答信号（SDA线为低电平）：
1. 当I2C接口处于主接收模式时，接收到一个数据字节。
2. 当I2C接口处于可寻址的从接收模式时，接收到一个数据字节。
3. 接收到从地址寄存器中的地址。
4. 当I2ADR中的通用调用位（GC）置位时，接收到通用调用地址。

向I2CONCLR寄存器中的AAC位写入1会使AA位清零。当AA为零时，在SCL线的应答时钟脉冲内，出现下列情况将返回一个非应答信号（SDA线为高电平）：
1. 当I2C接口处于主接收模式时，接收到一个数据字节。
2. 当I2C接口处于可寻址的从接收模式时，接收到一个数据字节。

SI为I2C中断标志：当进入25种可能的I2C状态中的任何一个后，该位置位。
向I2CONCLR寄存器中的SIC位写入1使SI位清零。

STO为停止标志：
1. 在主模式中，置位STO位时向I2C总线发送一个停止条件。当总线检测到停止条件时，STO自动清零。
2. 在从模式中，置位STO位可从错误状态中恢复。这种情况下不向总线发送停止条件。STO标志由硬件自动清零。

STA为起始标志。
1. 当STA=1时，I2C接口进入主模式并发送一个起始条件，如果已经处于主模式，则发送一个重复起始条件。
2. 向I2CONCLR寄存器中的STAC位写入1使STA位清零,当STA=0时，不会产生起始或重复起始条件。

I2EN为I2C接口使能。
1. 当该位置位时，使能I2C接口。
2. 向I2CONCLR寄存器中的I2ENC位写入1将使I2EN位清零。当I2EN位为0时，I2C功能被禁止。

---

## 2. I2C控制清零寄存器I2CONCLR

功能：与I2CONSET寄存器的功能相反，它用于清零I2C通信的相关标志位。

位|7|6|5|4|3|2|[1:0]
---|---
功能|保留|使能清零|起始标志清零|保留|IIC中断标志清零|应答标志清零|保留

---

## 3. I2C状态寄存器I2STAT

功能：只读。有26种可能状态。除0xF8外，所有其它25种状态代码都对应一个已定义的I2C状态，当进入其中一种状态时，SI位将置位。

位|功能|描述|复位值
---|---
2:0|状态|总为0|0
7:3|状态|状态位|1

---

## 4. I2C数据寄存器I2DAT

功能：7位，包含发送/接收数据

1. I2DAT寄存器包含要发送或刚接收的数据。
2. 该寄存器只能在SI置位时访问。在SI置位期间，I2DAT中的数据保持稳定。
3. I2DAT中的数据移位总是从最高位开始：第一个发送的位是MSB（位7），第一个接收到的位存放在I2DAT的MSB。

---

## 5. I2C从地址寄存器


1. I2ADR寄存器只能在I2C设置为从模式时才能使用。在主模式中，该寄存器无效。
2. I2ADR的LSB为通用调用位。当该位置位时，通用调用地址（0x00）被识别（即可以对广播地址0x00作出响应）。  
。

---

## 6. I2C占空比寄存器： I2SCLH、I2SCLL

I2SCLH、I2SCLL寄存器用于控制I2C通信的波特率。其中I2SCLH定义SCL高电平所保持的PCLK周期数，而I2SCLL定义SCL低电平所保持的PCLK周期数。那么位频率（即总线速率）由下面的公式得出：

位频率 = Fpclk / (I2SCLH + I2SCLL)

---

# 三. IIC应用示例


```c
Void I2C_init(uint32 fi2c)                   //传入参数时钟频率
{
    if(fi2c > 400000)
        fi2c = 400000;
    PINSEL0 = (PINSEL0 & 0xFFFFFF0F) | 0x50; // 0b 0101 0000
    I2SCLH = (Fpclk / fi2c + 1) / 2;         // 设置通信波特率
    I2SCLL = (Fpclk / fi2c) / 2;
    I2CONCLR = 0x2C;                         // 使能主IIC
    I2CONSET = 0x40;
    VICIntSelect = 0x00000000;
    VICVectCntl0 = 0x29;                     // 0b 0001 1001 使能+通道号9
    VICVectAddr0 = (int)IRQ_I2C;
    VICIntEnable = 0x0200;       // 0b 0000 0010 0000 0000 （1左移9位）
}

```

---

一个系统采用UART0实现数据传输到PC；通过I2C接口实现EEPROM的存储操作，I2Cinit()函数完成了I2C的初始化过程，请编写程序设置UART0的初始化程序，要求数据格式为8个数据位、1个停止位、偶校验，波特率为19200,并编写数据发送子函数。其中Fpclk=11059200。


```c
void UARTinit（void）
{	uint16 Fdiv;
     PINSEL0 = (PINSEL0&0xFFFFFFF0) | 0x5;
     U0LCR = 0x83;	 
     Fdiv = (Fpclk / 16) / 19200;         
     U0DLM = Fdiv / 256;							
     U0DLL = Fdiv % 256;						
     U0LCR = 0x1b;             
}

Void UART0_SendByte(char s_dat)
{
    U0THR = s_dat ;   //写入数据
    while((U0LSR & 0x40)==0) ;  //等待发送完毕
}



int main（void）
{
    I2Cinit();
    UARTinit();
    while(1);{
      .........//主函数代码
   }
  return(0);
}


```
